# shaka-player-multi-period
I have `input.mp4` (duration: 30 seconds) , and I want to split it based on 10 seconds.
# Step 1:
```python
ffmpeg -i input.mp4 -c copy -map 0 -segment_time 10 -f segment input_%03d.mp4
```
output:
```
input_000.mp4
input_001.mp4
input_002.mp4
```

# Step 2:
```python
MP4Box -dash 10000 input_000.mp4:period=0 input_001.mp4:period=1 input_002.mp4:period=2 -out out.mpd
```

output:
```
input_000_dashinit.mp4
input_001_dashinit.mp4
input_002_dashinit.mp4
out.mpd
```

# out.mpd:
```xml
<?xml version="1.0"?>
<!-- MPD file Generated with GPAC version 2.3-DEV-rev476-gebfad0b5-master at 2024-03-21T09:42:00.505Z -->
<MPD xmlns="urn:mpeg:dash:schema:mpd:2011" minBufferTime="PT1.500S" type="static" mediaPresentationDuration="PT0H0M30.077S" maxSegmentDuration="PT0H0M10.136S" profiles="urn:mpeg:dash:profile:full:2011">
 <ProgramInformation moreInformationURL="http://gpac.io">
  <Title>out.mpd generated by GPAC</Title>
 </ProgramInformation>

 <Period id="0" duration="PT0H0M10.346S">
  <AdaptationSet segmentAlignment="true" maxWidth="852" maxHeight="480" maxFrameRate="24000/1001" par="16:9" lang="ja" startWithSAP="1">
   <ContentComponent id="1" contentType="video"/>
   <ContentComponent id="2" contentType="audio"/>
   <Representation id="1" mimeType="video/mp4" codecs="avc1.4D4028,mp4a.40.2" width="852" height="480" frameRate="24000/1001" sar="640:639" bandwidth="989991">
    <AudioChannelConfiguration schemeIdUri="urn:mpeg:dash:23003:3:audio_channel_configuration:2011" value="2"/>
    <BaseURL>input_000_dashinit.mp4</BaseURL>
    <SegmentList timescale="24000" duration="240000">
     <Initialization range="0-1401"/>
     <SegmentURL mediaRange="1402-1379514" indexRange="1402-1445"/>
    </SegmentList>
   </Representation>
  </AdaptationSet>
 </Period>
 <Period id="1" duration="PT0H0M10.389S">
  <AdaptationSet segmentAlignment="true" maxWidth="852" maxHeight="480" maxFrameRate="24000/1001" par="16:9" lang="ja" startWithSAP="1">
   <ContentComponent id="1" contentType="video"/>
   <ContentComponent id="2" contentType="audio"/>
   <Representation id="2" mimeType="video/mp4" codecs="avc1.4D4028,mp4a.40.2" width="852" height="480" frameRate="24000/1001" sar="640:639" bandwidth="122979">
    <AudioChannelConfiguration schemeIdUri="urn:mpeg:dash:23003:3:audio_channel_configuration:2011" value="2"/>
    <BaseURL>input_001_dashinit.mp4</BaseURL>
    <SegmentList timescale="24000" duration="240000">
     <Initialization range="0-1449"/>
     <SegmentURL mediaRange="1450-476320" indexRange="1450-1493"/>
     <SegmentURL mediaRange="476321-496706" indexRange="476321-476364"/>
    </SegmentList>
   </Representation>
  </AdaptationSet>
 </Period>
 <Period id="2" duration="PT0H0M9.342S">
  <AdaptationSet segmentAlignment="true" maxWidth="852" maxHeight="480" maxFrameRate="24000/1001" par="16:9" lang="ja" startWithSAP="1">
   <ContentComponent id="1" contentType="video"/>
   <ContentComponent id="2" contentType="audio"/>
   <Representation id="3" mimeType="video/mp4" codecs="avc1.4D4028,mp4a.40.2" width="852" height="480" frameRate="24000/1001" sar="640:639" bandwidth="228267">
    <AudioChannelConfiguration schemeIdUri="urn:mpeg:dash:23003:3:audio_channel_configuration:2011" value="2"/>
    <BaseURL>input_002_dashinit.mp4</BaseURL>
    <SegmentList timescale="24000" duration="240000">
     <Initialization range="0-1449"/>
     <SegmentURL mediaRange="1450-1014178" indexRange="1450-1493"/>
    </SegmentList>
   </Representation>
  </AdaptationSet>
 </Period>
</MPD>
```


# HTML file:
```html
<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.compiled.js"></script>
  </head>
  <body>
    <video id="video" width="640" controls></video>
    <script>
        const shaka = window.shaka;
        const video = document.getElementById("video");
        const player = new shaka.Player(video);

        video.addEventListener("play", () => {
            player.configure({
                streaming: {
                rebufferingGoal: 10,
                bufferingGoal: 10
                }
            });
        });

        player.load(
            //"https://storage.googleapis.com/shaka-demo-assets/angel-one/dash.mpd"
            "https://raw.githubusercontent.com/azoozs/shaka-player-multi-period/main/videos/out.mpd"
        );

    </script>
  </body>
</html>
```

https://storage.googleapis.com/shaka-demo-assets/angel-one/dash.mpd it is work
but my .mpd https://raw.githubusercontent.com/azoozs/shaka-player-multi-period/main/videos/out.mpd (multi-period) doesn't work , why ? 

# The Question:
Why `rebufferingGoal: 10`,`bufferingGoal: 10` don't work with multi-period `mpeg dash`


# Solution:

I’ve discovered that the issue isn’t linked to bufferingGoal. Instead, it’s due to minor gaps between periods. I believe this occurs because MP4Box sets the duration of each period based on the audio stream’s duration, not the video stream’s. You can verify the duration of the video stream using `ffprobe`:

```python
import subprocess
import json
import datetime

command = f"ffprobe -v quiet -print_format json -show_format -show_streams input_001.mp4"

# Execute the command and get the output
process = subprocess.Popen(command, stdout=subprocess.PIPE, shell=True)
out, err = process.communicate()

# Convert the output to a Python dictionary
output_dict = json.loads(out)

# Extract the video stream duration
for stream in output_dict['streams']:
    if stream['codec_type'] == 'video':
        video_duration = stream['duration']
        print(f"Video Duration: {video_duration}")
    if stream['codec_type'] == 'audio':
        audio_duration = stream['duration']
        print(f"Audio Duration: {audio_duration}")

```

Afterwards, you’ll need to manually adjust the duration of each period. This should resolve the issue.
